# Generated by configure script
variable "NGINX_VERSIONS" {
    type = list(string)
    default = []
}
variable "NGINX_MODULES" {
    type = list(string)
    default = []
}

variable "REGISTRY_IMAGE" { default = "chocolatefrappe/nginx-modules" }

// Local variables for NGINX versions and channels.
// These are used to generate the matrix for building images with different NGINX versions and modules.
variable "_NGINX_CHANNEL_VERSIONS" {
    type = list(string)
    default = ["stable", "mainline"]
}
variable "_NGINX_CANONICAL_VERSIONS" {
    type = list(string)
    default = setunion([for ver in NGINX_VERSIONS : regex_replace(ver, "^(.+)\\.(.+)\\.(.+)", "$1.$2")])
}

# NGINX targets for building images with various modules enabled.
group "default" {
    targets = [
        "nginx-modules-alpine",
        "nginx-modules-debian",
    ]
}
group "alpine" {
    targets = [
        "nginx-modules-alpine",
    ]
}
group "debian" {
    targets = [
        "nginx-modules-debian",
    ]
}

target "pkg-oss" {
    context = "pkg-oss"
    output = [ "pkg-oss" ]
    platforms = [ "local" ]
}

target "nginx-modules-alpine" {
    dockerfile = "alpine/Dockerfile"
    matrix = {
        NGINX_VERSION = flatten([_NGINX_CHANNEL_VERSIONS, NGINX_VERSIONS, _NGINX_CANONICAL_VERSIONS])
        ENABLED_MODULE = NGINX_MODULES
    }
    name = "nginx-modules-alpine-${sanitize(NGINX_VERSION)}-${ENABLED_MODULE}"
    args = {
        NGINX_VERSION = NGINX_VERSION,
        ENABLED_MODULES = ENABLED_MODULE,
    }
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-alpine-${ENABLED_MODULE}"
    ]
}

target "nginx-modules-debian" {
    dockerfile = "debian/Dockerfile"
    matrix = {
        NGINX_VERSION = flatten([_NGINX_CHANNEL_VERSIONS, NGINX_VERSIONS, _NGINX_CANONICAL_VERSIONS])
        ENABLED_MODULE = NGINX_MODULES
    }
    name = "nginx-modules-debian-${sanitize(NGINX_VERSION)}-${ENABLED_MODULE}"
    args = {
        NGINX_VERSION = NGINX_VERSION,
        ENABLED_MODULES = ENABLED_MODULE,
    }
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-${ENABLED_MODULE}"
    ]
}

target "test" {
  matrix = {
        NGINX_VERSION = flatten([_NGINX_CHANNEL_VERSIONS, NGINX_VERSIONS, _NGINX_CANONICAL_VERSIONS])
    }
    name = "nginx-modules-alpine-${sanitize(NGINX_VERSION)}"
}
