# Generated by configure script
variable "NGINX_VERSION" { default = "stable" }
variable "NGINX_MODULES" { default = "brotli" }
variable "REGISTRY_IMAGE" { default = "chocolatefrappe/nginx-modules" }

# Target for building a short-lived NGINX image with https://ttl.sh
# This image is used for testing purposes and will be removed after 24 hours.
# It is not intended for intermediate build layer for other images.
variable "NGINX_TTL_VARIANT" { default = "alpine" }
# ttl.sh/nginx-module-builder-${NGINX_TTL_VARIANT}-${NGINX_VERSION}:24h
variable "NGINX_TTL_IMAGE_TAG" { default = "nginx-module-builder" }
target "nginx-module-builder" {
    inherits = [ "nginx-modules-${NGINX_TTL_VARIANT}" ]
    target = "nginx-module-builder"
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${NGINX_TTL_IMAGE_TAG}"
    ]
}

# NGINX targets for building images with various modules enabled.
group "default" {
    targets = [
        "nginx-modules-alpine",
        "nginx-modules-debian",
    ]
}

target "nginx-modules-alpine-test" {
    inherits = [ "nginx-modules-alpine" ]
    platforms = []
}
target "nginx-modules-alpine" {
    dockerfile = "alpine/Dockerfile"
    args = {
        ENABLED_MODULES = "${NGINX_MODULES}",
        NGINX_VERSION = "${NGINX_VERSION}",
        NGINX_TTL_IMAGE_TAG = NGINX_TTL_IMAGE_TAG,
    }
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-alpine-${NGINX_MODULES}"
    ]
}

target "nginx-modules-debian-test" {
    inherits = [ "nginx-modules-debian" ]
    platforms = []
}
target "nginx-modules-debian" {
    dockerfile = "debian/Dockerfile"
    args = {
        ENABLED_MODULES = "${NGINX_MODULES}",
        NGINX_VERSION = "${NGINX_VERSION}",
        NGINX_TTL_IMAGE_TAG = "${NGINX_TTL_IMAGE_TAG}",
    }
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-${NGINX_MODULES}"
    ]
}

# .
