# Generated by configure script
variable "NGINX_VERSIONS" {
    type = list(string)
    default = []
}
variable "NGINX_MODULES" {
    type = list(string)
    default = []
}

variable "REGISTRY_IMAGE" { default = "chocolatefrappe/nginx-modules" }

# NGINX targets for building images with various modules enabled.
group "default" {
    targets = [
        "nginx-modules-alpine",
        "nginx-modules-debian",
    ]
}
group "alpine" {
    targets = [
        "nginx-modules-alpine",
    ]
}
group "debian" {
    targets = [
        "nginx-modules-debian",
    ]
}

// docker/metadata-
target "docker-metadata-action" {}

target "docker-target-platforms" {
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
}

target "pkg-oss" {
    context = "pkg-oss"
    output = [ "pkg-oss" ]
    platforms = [ "local" ]
}

group "nginx-modules-builder" {
    targets = [
        "nginx-modules-alpine-builder",
        "nginx-modules-debian-builder",
    ]
}

target "nginx-modules-alpine-builder" {
    inherits = [
        "docker-metadata-action",
        "docker-target-platforms",
    ]
    dockerfile = "alpine/Dockerfile"
    matrix = {
        NGINX_VERSION = NGINX_VERSIONS
    }
    name = "nginx-modules-alpine-builder-${replace(NGINX_VERSION, ".", "-")}"
    target = "base-builder"
    args = {
        NGINX_VERSION = NGINX_VERSION,
    }
    tags = [
        "ghcr.io/${REGISTRY_IMAGE}:builder-${NGINX_VERSION}-alpine",
    ]
}
target "nginx-modules-alpine" {
    inherits = [
        "docker-metadata-action",
        "docker-target-platforms",
    ]
    dockerfile = "alpine/Dockerfile"
    matrix = {
        NGINX_VERSION = NGINX_VERSIONS
        ENABLED_MODULE = NGINX_MODULES
    }
    name = "nginx-modules-alpine-${replace(NGINX_VERSION, ".", "-")}-${ENABLED_MODULE}"
    args = {
        NGINX_VERSION = NGINX_VERSION,
        ENABLED_MODULES = ENABLED_MODULE,
    }
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-alpine-${ENABLED_MODULE}",
        "ghcr.io/${REGISTRY_IMAGE}:${NGINX_VERSION}-alpine-${ENABLED_MODULE}",
    ]
}

target "nginx-modules-debian-builder" {
    inherits = [
        "docker-metadata-action",
        "docker-target-platforms",
    ]
    dockerfile = "debian/Dockerfile"
    matrix = {
        NGINX_VERSION = NGINX_VERSIONS
    }
    name = "nginx-modules-debian-builder-${replace(NGINX_VERSION, ".", "-")}"
    target = "base-builder"
    args = {
        NGINX_VERSION = NGINX_VERSION,
    }
    tags = [
        "ghcr.io/${REGISTRY_IMAGE}:builder-${NGINX_VERSION}",
    ]
}
target "nginx-modules-debian" {
    inherits = [
        "docker-metadata-action",
        "docker-target-platforms",
    ]
    dockerfile = "debian/Dockerfile"
    matrix = {
        NGINX_VERSION = NGINX_VERSIONS
        ENABLED_MODULE = NGINX_MODULES
    }
    name = "nginx-modules-debian-${replace(NGINX_VERSION, ".", "-")}-${ENABLED_MODULE}"
    args = {
        NGINX_VERSION = NGINX_VERSION,
        ENABLED_MODULES = ENABLED_MODULE,
    }
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-${ENABLED_MODULE}",
        "ghcr.io/${REGISTRY_IMAGE}:${NGINX_VERSION}-${ENABLED_MODULE}",
    ]
}
