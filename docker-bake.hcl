# Generated by configure script
variable "NGINX_VERSIONS" {
    type = list(string)
    default = []
}
variable "NGINX_MODULES" {
    type = list(string)
    default = []
}

variable "REGISTRY_IMAGE" { default = "chocolatefrappe/nginx-modules" }

# NGINX targets for building images with various modules enabled.
group "default" {
    targets = [
        "nginx-modules-alpine",
        "nginx-modules-debian",
    ]
}
group "alpine" {
    targets = [
        "nginx-modules-alpine",
    ]
}
group "debian" {
    targets = [
        "nginx-modules-debian",
    ]
}

target "pkg-oss" {
    context = "pkg-oss"
    output = [ "pkg-oss" ]
    platforms = [ "local" ]
}

target "nginx-modules-alpine" {
    dockerfile = "alpine/Dockerfile"
    matrix = {
        NGINX_VERSION = NGINX_VERSIONS
        ENABLED_MODULE = NGINX_MODULES
    }
    name = "nginx-modules-alpine-${NGINX_VERSION}-${ENABLED_MODULE}"
    args = {
        NGINX_VERSION = NGINX_VERSION,
        ENABLED_MODULES = ENABLED_MODULE,
    }
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-alpine-${ENABLED_MODULE}"
    ]
}

target "nginx-modules-debian" {
    dockerfile = "debian/Dockerfile"
    matrix = {
        NGINX_VERSION = NGINX_VERSIONS
        ENABLED_MODULE = NGINX_MODULES
    }
    name = "nginx-modules-debian-${NGINX_VERSION}-${ENABLED_MODULE}"
    args = {
        NGINX_VERSION = NGINX_VERSION,
        ENABLED_MODULES = ENABLED_MODULE,
    }
    platforms = [
        "linux/amd64",
        "linux/arm64",
    ]
    tags = [
        "${REGISTRY_IMAGE}:${NGINX_VERSION}-${ENABLED_MODULE}"
    ]
}
