#!/bin/bash

BAKE_FILE="docker-bake.hcl"
BAKE_TARGET_MATRIX=$(jq -cr 'keys' nginx-modules.json)
ENABLED_MODULES=$(jq -cr 'keys | join(" ")' nginx-modules.json)

if [ -f "$BAKE_FILE" ]; then
    rm $BAKE_FILE
fi
if [ -f "alpine/Dockerfile" ]; then
    rm alpine/Dockerfile
    cp alpine/template.Dockerfile alpine/Dockerfile
fi
if [ -f "debian/Dockerfile" ]; then
    rm debian/Dockerfile
    cp debian/template.Dockerfile debian/Dockerfile
fi

echo "Generating $BAKE_FILE file..."

echo "# Generated by configure script" > $BAKE_FILE
{
    echo 'variable "REGISTRY_IMAGE" { default = "chocolatefrappe/nginx-modules" }'
    echo 'variable "NGINX_VERSION" { default = "stable" }'
    echo ''
    echo 'target "nginx-modules-alpine" {'
    echo '    name = "nginx-module-${module}"'
    echo '    target = "nginx-module-${module}"'
    echo '    dockerfile = "alpine/Dockerfile"'
    echo '    matrix = {'
    echo '        module = '${BAKE_TARGET_MATRIX}
    echo '    }'
    echo '    args = {'
    echo '        NGINX_VERSION = "${NGINX_VERSION}"',
    echo '        ENABLED_MODULES = "'${ENABLED_MODULES}'"',
    echo '    }'
    echo '    platforms = ['
    echo '        "linux/amd64",'
    echo '        "linux/arm64",'
    echo '    ]'
    echo '    tags = ['
    echo '        "${REGISTRY_IMAGE}:${NGINX_VERSION}-alpine-${module}"'
    echo '    ]'
    echo '}'
    echo ''
    echo 'target "nginx-modules-debian" {'
    echo '    name = "nginx-module-${module}"'
    echo '    target = "nginx-module-${module}"'
    echo '    dockerfile = "debian/Dockerfile"'
    echo '    matrix = {'
    echo '        module = '${BAKE_TARGET_MATRIX}
    echo '    }'
    echo '    args = {'
    echo '        NGINX_VERSION = "${NGINX_VERSION}"',
    echo '        ENABLED_MODULES = "'${ENABLED_MODULES}'"',
    echo '    }'
    echo '    platforms = ['
    echo '        "linux/amd64",'
    echo '        "linux/arm64",'
    echo '    ]'
    echo '    tags = ['
    echo '        "${REGISTRY_IMAGE}:${NGINX_VERSION}-${module}"'
    echo '    ]'
    echo '}'
    echo ''
} >> $BAKE_FILE

echo "Generating Dockerfiles..."
for module in ${ENABLED_MODULES}; do
    echo '    Adding "'$module'" to Dockerfiles...'
    {
        echo 'FROM scratch AS nginx-module-'$module
        echo 'COPY --from=builder /tmp/module-available.d/'$module' /module-available.d/'
        echo 'COPY --from=builder /tmp/packages/nginx-module-'$module'* /packages/'
        echo ''
    } | tee -a alpine/Dockerfile | tee -a debian/Dockerfile > /dev/null
done

echo "Done!"
