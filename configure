#!/bin/bash

ENABLED_MODULE=$(jq -cr 'keys | join(" ")' nginx-modules.json)
BAKE_FILE="docker-bake.hcl"

echo "Configuring nginx-modules..."

if [ -f "$BAKE_FILE" ]; then
    rm $BAKE_FILE
fi
if [ -f "alpine/Dockerfile" ]; then
    rm alpine/Dockerfile
    cp alpine/template.Dockerfile alpine/Dockerfile
fi
if [ -f "debian/Dockerfile" ]; then
    rm debian/Dockerfile
    cp debian/template.Dockerfile debian/Dockerfile
fi

echo "# Generated by configure script" > $BAKE_FILE

{
    echo 'variable "TAG" { default = "chocolatefrappe/nginx-modules" }'
    echo 'variable "NGINX_VERSION" { default = "stable" }'
    echo ''
    echo 'target "nginx-module-builder" {'
    echo '    args = {'
    echo '        NGINX_VERSION = "${NGINX_VERSION}"'
    echo '        ENABLED_MODULES = "'$ENABLED_MODULE'"'
    echo '    }'
    # echo '    platforms = ['
    # echo '        "linux/amd64",'
    # echo '        "linux/arm64",'
    # echo '    ]'
    echo '}'
    echo ''
} >> $BAKE_FILE

# alpine
{
    echo 'group "nginx-modules-alpine" {'
    echo '    targets = ['
    for module in $ENABLED_MODULE; do
        echo '        "nginx-module-'$module'-alpine",'
    done
    echo '    ]'
    echo '}'
    echo ''
} >> $BAKE_FILE

# debian
{
    echo 'group "nginx-modules-debian" {'
    echo '    targets = ['
    for module in $ENABLED_MODULE; do
        echo '        "nginx-module-'$module'-debian",'
    done
    echo '    ]'
    echo '}'
    echo ''
} >> $BAKE_FILE

for module in $ENABLED_MODULE; do
    echo "  [+] Rendering $module..."
    echo "     - Adding $module to nginx-modules.hcl..."

    echo '# '$module >> $BAKE_FILE
    # alpine
    {
        echo 'target "nginx-module-'$module'-alpine" {'
        echo '    inherits = ["nginx-module-builder"]'
        echo '    dockerfile = "alpine/Dockerfile"'
        echo '    target = "nginx-module-'$module'"'
        echo '    tags = ['
        echo '        "${TAG}:${NGINX_VERSION}-alpine-'$module'"'
        echo '    ]'
        echo '}'
    } >> $BAKE_FILE

    # debian
    {
        echo 'target "nginx-module-'$module'-debian" {'
        echo '    inherits = ["nginx-module-builder"]'
        echo '    dockerfile = "debian/Dockerfile"'
        echo '    target = "nginx-module-'$module'"'
        echo '    tags = ['
        echo '        "${TAG}:${NGINX_VERSION}-'$module'"'
        echo '    ]'
        echo '}'
        echo ''
    } >> $BAKE_FILE

    echo "     - Adding $module to Dockerfiles..."
    {
        echo 'FROM scratch AS nginx-module-'$module
        echo 'COPY --from=builder /tmp/module-available.d/'$module' /module-available.d/'
        echo 'COPY --from=builder /tmp/packages/nginx-module-'$module'* /packages/'
        echo ''
    } | tee -a alpine/Dockerfile | tee -a debian/Dockerfile > /dev/null
done

echo "nginx-modules configured!"
